#!groovy
@Library("Infrastructure")

def product = "sscs"
def component = "ccd-definitions"

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

def secrets = [
        'sscs-${env}': [
                secret('test-e2e-caseofficer-username', 'TEST_CASEOFFICER_USERNAME'),
                secret('test-e2e-caseofficer-password', 'TEST_CASEOFFICER_PASSWORD'),
                secret('test-e2e-judge-username', 'TEST_JUDGE_USERNAME'),
                secret('test-e2e-judge-password', 'TEST_JUDGE_PASSWORD'),
                secret('test-e2e-dwp-username', 'TEST_DWP_USERNAME'),
                secret('test-e2e-dwp-password', 'TEST_DWP_PASSWORD')
        ]
]

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
    [$class     : 'AzureKeyVaultSecret',
     secretType : 'Secret',
     name       : secretName,
     version    : '',
     envVariable: envVar
    ]
}

withPipeline("nodejs", product, component) {
  loadVaultSecrets(secrets)

  disableLegacyDeployment()

    before('functionalTest:preview') {
        yarnBuilder.yarn('setup')
        env.TEST_E2E_URL_WEB = "https://www-ccd.aat.platform.hmcts.net/list/case?jurisdiction=sscs"
        env.TEST_E2E_URL_GATEWAY = "https://gateway-ccd.aat.platform.hmcts.net"
        env.TEST_E2E_NUM_BROWSERS = 4
        env.TEST_E2E_WAIT_FOR_ANGULAR = 'false'
        env.TEST_E2E_FAIL_FAST = 'false'
        env.TEST_E2E_ANNOTATION = "--cucumberOpts.tags=@nightly-test"
    }
    after('functionalTest:preview') {
        steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'test/functional/output/mochawesome.html'
    }

  println """done!""".stripIndent()
}
